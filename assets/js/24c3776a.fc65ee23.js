"use strict";(self.webpackChunkignite_cookbook=self.webpackChunkignite_cookbook||[]).push([[9828],{176:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>l,frontMatter:()=>a,metadata:()=>r,toc:()=>u});var i=n(7624),o=n(2172);const a={title:"Distributing Auth Token to APIs",description:"Use token stored in Authentication Store with API Sauce",tags:["Authentication","Apisauce","Guide"],last_update:{author:"Ellie Croce"},publish_date:new Date("2023-05-09T00:00:00.000Z")},s="Distributing Auth Token to APISauce",r={id:"recipes/DistributingAuthTokenToAPI",title:"Distributing Auth Token to APIs",description:"Use token stored in Authentication Store with API Sauce",source:"@site/docs/recipes/DistributingAuthTokenToAPI.md",sourceDirName:"recipes",slug:"/recipes/DistributingAuthTokenToAPI",permalink:"/docs/recipes/DistributingAuthTokenToAPI",draft:!1,unlisted:!1,tags:[{label:"Authentication",permalink:"/docs/tags/authentication"},{label:"Apisauce",permalink:"/docs/tags/apisauce"},{label:"Guide",permalink:"/docs/tags/guide"}],version:"current",lastUpdatedBy:"Ellie Croce",lastUpdatedAt:1684873013,formattedLastUpdatedAt:"May 23, 2023",frontMatter:{title:"Distributing Auth Token to APIs",description:"Use token stored in Authentication Store with API Sauce",tags:["Authentication","Apisauce","Guide"],last_update:{author:"Ellie Croce"},publish_date:"2023-05-09T00:00:00.000Z"},sidebar:"mainSidebar",previous:{title:"Detox Intro",permalink:"/docs/recipes/DetoxIntro"},next:{title:"EAS Update",permalink:"/docs/recipes/EASUpdate"}},c={},u=[{value:"Review of API Instance and Auth Store",id:"review-of-api-instance-and-auth-store",level:2},{value:"Distributing Auth Token to API Instance",id:"distributing-auth-token-to-api-instance",level:2},{value:"Other configuration",id:"other-configuration",level:3}];function h(e){const t={code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.M)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.h1,{id:"distributing-auth-token-to-apisauce",children:"Distributing Auth Token to APISauce"}),"\n",(0,i.jsx)(t.p,{children:"Building off of the Ignite Boilerplate, this recipe will show you how to connect your Mobx State Tree Authentication Store with an Apisauce instance to make authenticating your API requests a breeze."}),"\n",(0,i.jsx)(t.h2,{id:"review-of-api-instance-and-auth-store",children:"Review of API Instance and Auth Store"}),"\n",(0,i.jsx)(t.p,{children:"To start off let's quickly review the boilerplate Auth Store and API Instance."}),"\n",(0,i.jsxs)(t.p,{children:["In ",(0,i.jsx)(t.code,{children:"app/services/api/api.ts"})," we have an example API class with an export of a singleton instance of that class at the end of the file. This api singleton is what we're going to use to update the apisauce configuration on the instance outside of this file."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-tsx",children:'export const DEFAULT_API_CONFIG: ApiConfig = {\n  url: Config.API_URL,\n  timeout: 10000,\n}\n\n\nexport class Api {\n  apisauce: ApisauceInstance\n  config: ApiConfig\n\n  constructor(config: ApiConfig = DEFAULT_API_CONFIG) {\n    this.config = config\n    this.apisauce = create({\n      baseURL: this.config.url,\n      timeout: this.config.timeout,\n      headers: {\n        Accept: "application/json",\n      },\n    })\n  }\n\n  async getEpisodes(): Promise<{ kind: "ok"; episodes: EpisodeSnapshotIn[] } | GeneralApiProblem> {\n    ... // example API call that needs authenticating\n  }\n\n}\n\n// Singleton instance of the API for convenience\nexport const api = new Api()\n'})}),"\n",(0,i.jsxs)(t.p,{children:["Next in ",(0,i.jsx)(t.code,{children:"app/models/AuthenticationStore.ts"})," we have an action to set the auth token in the store after retrieving it."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-tsx",children:'import { Instance, SnapshotOut, types } from "mobx-state-tree";\n\nexport const AuthenticationStoreModel = types\n  .model("AuthenticationStore")\n  .props({\n    authToken: types.maybe(types.string),\n    authEmail: "",\n  })\n  .views((store) => ({}))\n  .actions((store) => ({\n    setAuthToken(value?: string) {\n      store.authToken = value;\n    },\n  }));\n\nexport interface AuthenticationStore\n  extends Instance<typeof AuthenticationStoreModel> {}\nexport interface AuthenticationStoreSnapshot\n  extends SnapshotOut<typeof AuthenticationStoreModel> {}\n'})}),"\n",(0,i.jsx)(t.h2,{id:"distributing-auth-token-to-api-instance",children:"Distributing Auth Token to API Instance"}),"\n",(0,i.jsx)(t.p,{children:"Once we have an auth token and setAuthToken has been called, we need to hydrate the authentication header on all APIs that require requests to be authenticated. One of the easiest ways to do that is to grab the instance(s) in an action on the authStore and update the apiSauce configuration directly like so:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-tsx",children:'\t// We will need to import the api from the service\n\timport { api } from "app/services/api"\n\n  ...\n\n  // then update the Authentication Model actions\n  .actions((store) => ({\n    setAuthToken(value?: string) {\n      store.authToken = value;\n    },\n    distributeAuthToken(value?: string) {\n      // optionally grab the store\'s authToken if not passing a value\n      const token = value || store.authToken;\n      api.apiSauce.setHeader("Authorization", `Bearer ${token}`);\n    },\n  })\n'})}),"\n",(0,i.jsx)(t.p,{children:"From there you have a couple options of where to trigger the distribution."}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Add another action that calls both setAuthToken and distributeAuthToken and replace wherever you call setAuthToken with this new dual action"}),"\n",(0,i.jsx)(t.li,{children:"Call distributeAuthToken immediately after wherever you are calling setAuthToken"}),"\n",(0,i.jsx)(t.li,{children:"Add the distributeAuthToken call to the setAuthToken action (not recommended because it doesn't follow the SRP of the action)"}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["For example in ",(0,i.jsx)(t.code,{children:"app/screens/LoginScreen.tsx"})," we can update the login function to distribute the auth token after setting it in the store."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-tsx",children:'\t// We can update `authenticationStore` from the useStores hook to include `distributeAuthToken`\n\tconst {\n\t    authenticationStore: { authEmail, setAuthEmail, setAuthToken, distributeAuthToken, validationError },\n\t  } = useStores()\n\n\t  ...\n\n  function login() {\n    setIsSubmitted(true);\n    setAttemptsCount(attemptsCount + 1);\n\n    if (validationError) return;\n\n    // Make a request to your server to get an authentication token.\n    // If successful, reset the fields and set the token.\n    setIsSubmitted(false);\n    setAuthPassword("");\n    setAuthEmail("");\n\n    // We\'ll mock this with a fake token.\n    const token = String(Date.now());\n    setAuthToken(token);\n    distributeAuthToken(token);\n  }\n'})}),"\n",(0,i.jsx)(t.p,{children:"And that's it! Now all of your requests made using that API will include the authentication header, leveraging the auth token received on login."}),"\n",(0,i.jsx)(t.h3,{id:"other-configuration",children:"Other configuration"}),"\n",(0,i.jsx)(t.p,{children:"This method works for updating both the apisauce and config properties on the default API instance or any custom properties you have added to the API!"})]})}function l(e={}){const{wrapper:t}={...(0,o.M)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},2172:(e,t,n)=>{n.d(t,{I:()=>r,M:()=>s});var i=n(1504);const o={},a=i.createContext(o);function s(e){const t=i.useContext(a);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),i.createElement(a.Provider,{value:t},e.children)}}}]);