"use strict";(self.webpackChunkignite_cookbook=self.webpackChunkignite_cookbook||[]).push([[5576],{4492:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>r});var o=t(7624),a=t(2172);const i={title:"Extracting Apollo Client's Cache in Reactotron",description:"How to enhance your Ignite debugging experience when using the Apollo client with Custom Commands in Reactotron",tags:["Apollo Client","Cache","Reactotron","Custom Commands"],last_update:{author:"Frank Calise"},publish_date:new Date("2024-03-26T00:00:00.000Z")},l="Overview",s={id:"recipes/ApolloClientCache",title:"Extracting Apollo Client's Cache in Reactotron",description:"How to enhance your Ignite debugging experience when using the Apollo client with Custom Commands in Reactotron",source:"@site/docs/recipes/ApolloClientCache.md",sourceDirName:"recipes",slug:"/recipes/ApolloClientCache",permalink:"/docs/recipes/ApolloClientCache",draft:!1,unlisted:!1,tags:[{label:"Apollo Client",permalink:"/docs/tags/apollo-client"},{label:"Cache",permalink:"/docs/tags/cache"},{label:"Reactotron",permalink:"/docs/tags/reactotron"},{label:"Custom Commands",permalink:"/docs/tags/custom-commands"}],version:"current",lastUpdatedBy:"Frank Calise",lastUpdatedAt:1720037175,formattedLastUpdatedAt:"Jul 3, 2024",frontMatter:{title:"Extracting Apollo Client's Cache in Reactotron",description:"How to enhance your Ignite debugging experience when using the Apollo client with Custom Commands in Reactotron",tags:["Apollo Client","Cache","Reactotron","Custom Commands"],last_update:{author:"Frank Calise"},publish_date:"2024-03-26T00:00:00.000Z"},sidebar:"mainSidebar",previous:{title:"Accessiblity Font Sizes",permalink:"/docs/recipes/AccessibilityFontSizes"},next:{title:"Authentication with Supabase",permalink:"/docs/recipes/Authentication"}},c={},r=[{value:"Install Commands",id:"install-commands",level:2},{value:"Quick Apollo Client Setup",id:"quick-apollo-client-setup",level:2},{value:"Cache Snapshot",id:"cache-snapshot",level:2},{value:"Cache by Key",id:"cache-by-key",level:2}];function h(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.M)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"overview",children:"Overview"}),"\n",(0,o.jsxs)(n.p,{children:["This guide will teach you how to add two additional ",(0,o.jsx)(n.a,{href:"https://docs.infinite.red/reactotron/custom-commands/",children:"Custom Commands"})," for use within ",(0,o.jsx)(n.a,{href:"https://docs.infinite.red/reactotron/",children:"Reactotron"})," when using Ignite alongside the ",(0,o.jsx)(n.a,{href:"https://www.apollographql.com/docs/react/",children:"Apollo Client"})," library."]}),"\n",(0,o.jsx)(n.h1,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,o.jsx)(n.p,{children:"You'll need the following to get going with this recipe:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"An Ignite project with Reactotron configured (this is done for you)"}),"\n",(0,o.jsx)(n.li,{children:"Configured with an Apollo Client pointed at a GraphQL backend"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"install-commands",children:"Install Commands"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"npx ignite-cli@latest new ignite-apollo-cmds --yes\ncd ignite-apollo-cmds\nnpx expo install @apollo/client graphql\nmkdir app/stores/apollo\ntouch app/stores/apollo/index.tsx\n"})}),"\n",(0,o.jsx)(n.h2,{id:"quick-apollo-client-setup",children:"Quick Apollo Client Setup"}),"\n",(0,o.jsxs)(n.p,{children:["Open up ",(0,o.jsx)(n.code,{children:"app/stores/apollo/index.tsx"})," and initialize your Apollo Client, feel free to customize this to your liking:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-tsx",metastring:'title="app/stores/apollo/index.tsx"',children:'import { ApolloClient, InMemoryCache } from "@apollo/client";\n\nconst cache = new InMemoryCache();\n\nexport const client = new ApolloClient({\n  uri: "https://api.graphql.guide/graphql",\n  cache,\n  defaultOptions: {\n    watchQuery: { fetchPolicy: "cache-and-network" },\n  },\n});\n'})}),"\n",(0,o.jsxs)(n.p,{children:["Now we need to pass this client into the provider at the root app level, so open ",(0,o.jsx)(n.code,{children:"app/app.tsx"})," and wrap the return value that is already there:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-tsx",metastring:'title="app/app.tsx"',children:'// success-line-start\nimport { ApolloProvider } from "@apollo/client";\nimport { client as apolloClient } from "app/stores/apollo";\n// success-line-end\n\n// ...\n\nreturn (\n  // success-line\n  <ApolloProvider client={apolloClient}>\n    <SafeAreaProvider initialMetrics={initialWindowMetrics}>\n      <ErrorBoundary catchErrors={Config.catchErrors}>\n        <GestureHandlerRootView style={$container}>\n          <AppNavigator\n            linking={linking}\n            initialState={initialNavigationState}\n            onStateChange={onNavigationStateChange}\n          />\n        </GestureHandlerRootView>\n      </ErrorBoundary>\n    </SafeAreaProvider>\n    // success-line\n  </ApolloProvider>\n);\n'})}),"\n",(0,o.jsx)(n.h1,{id:"reactotron-config",children:"Reactotron Config"}),"\n",(0,o.jsx)(n.p,{children:"We'll be adding two additional commands to our Reactotron setup."}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Extract an entire snapshot of the current cache and display it to the timeline"}),"\n",(0,o.jsx)(n.li,{children:"Extract a specific key of the current cache and display it to the timeline"}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Both of these modifications will be added to ",(0,o.jsx)(n.code,{children:"app/devtools/ReactotronConfig.ts"}),". Before we add these, we'll need access to our client - so add the following import in that file: ",(0,o.jsx)(n.code,{children:'import { client as apolloClient } from "../stores/apollo"'})]}),"\n",(0,o.jsx)(n.h2,{id:"cache-snapshot",children:"Cache Snapshot"}),"\n",(0,o.jsxs)(n.p,{children:["Somewhere after the ",(0,o.jsx)(n.code,{children:"Reactotron.configure"})," statement (below or above the existing custom commands will work fine), add the following code"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-tsx",metastring:'title="app/devtools/ReactotronConfig.ts"',children:'reactotron.onCustomCommand({\n  title: "Extract Apollo Client Cache",\n  description: "Gets the updated InMemory cache from Apollo Client",\n  command: "extractApolloCache",\n  handler: () => {\n    Reactotron.display({\n      name: "Apollo Cache",\n      preview: "Cache Snapshot",\n      value: apolloClient.cache.extract(),\n    });\n  },\n});\n'})}),"\n",(0,o.jsx)(n.p,{children:"Now if we look at our Reactotron window, you'll see under the Custom Commands we have a new button! Press that and flip back to the timeline. You'll see we have a new list item that we can tap on and see the value of the in-memory cache from the Apollo Client"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://github.com/infinitered/ignite-cookbook/assets/374022/3afeba98-70e9-486a-bc98-f3cb2a18e4b3",alt:"Cache Snapshot Custom Command"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://github.com/infinitered/ignite-cookbook/assets/374022/14bbca18-23dc-4603-9fec-d7d3f78b2906",alt:"Cache Snapshot Timeline Collapsed"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://github.com/infinitered/ignite-cookbook/assets/374022/f4444809-42a2-4e92-9f34-4fdb2f0b11c1",alt:"Cache Snapshot Timeline Expanded"})}),"\n",(0,o.jsx)(n.h2,{id:"cache-by-key",children:"Cache by Key"}),"\n",(0,o.jsx)(n.p,{children:"Quite often, though, you're in-memory cache could be quite large and maybe you're not that interested in all the data. We can create another command that will do a look up specifically by the key we pass into the Reactotron UI."}),"\n",(0,o.jsxs)(n.p,{children:["To do this, we'll utilize the ",(0,o.jsx)(n.code,{children:"args"})," property to allow our command to take in a string. We'll then get access to that value in the ",(0,o.jsx)(n.code,{children:"handler"})," callback, which we can use however we wish."]}),"\n",(0,o.jsx)(n.p,{children:"Let's plan this out:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Upon press, make sure the user filled out a key, if not we'll log an error to the Timeline"}),"\n",(0,o.jsx)(n.li,{children:"Extract the cache and look for the requested key\na. if it doesn't exist, log an error to the Timeline\nb. if it does exist, return the value"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"To make this easier, we'll first create a helper function to extract a specific key path from the cache. This will allow us to request a key in some nested object, for example if we had the following:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n  "parent": {\n    "child": {\n      "someProp": 5\n    }\n  }\n}\n'})}),"\n",(0,o.jsxs)(n.p,{children:["We could directly request the value ",(0,o.jsx)(n.code,{children:"parent.child.someProp"})," to be logged out via this Custom Command. Here's a helper function that'll get you started, customize it how you like! This one will be able to access array value via their index in addition to a key directly."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-tsx",metastring:'title="app/devtools/ReactogronConfig.ts"',children:'function getNestedCacheValue(keyPath: string): any {\n  // Extract the entire cache\n  const cache: NormalizedCacheObject = client.cache.extract();\n\n  // Define a regular expression to match keys and array accessors\n  const pathSegmentRegex = /[^.[\\]]+|\\[\\d+\\]/g;\n\n  // Extract path segments, including array indices\n  const pathSegments = keyPath.match(pathSegmentRegex) || [];\n\n  // Navigate through the path segments to get to the desired value\n  const value = pathSegments.reduce((acc, segment) => {\n    // Check if the segment is an array accessor, e.g., [1]\n    if (segment.startsWith("[") && segment.endsWith("]")) {\n      // Extract the index from the segment and convert it to a number\n      const index = parseInt(segment.slice(1, -1), 10);\n      return acc ? acc[index] : undefined;\n    }\n    // Handle normal object property access\n    return acc ? acc[segment] : undefined;\n  }, cache);\n\n  return value ?? null; // Return null if the value is undefined at any point\n}\n'})}),"\n",(0,o.jsx)(n.p,{children:"With that in place, we can set up our new Custom Command:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-tsx",children:'reactotron.onCustomCommand({\n  title: "Extract Apollo Client Cache by Key",\n  description: "Retrieves a specific key from the Apollo Client cache",\n  command: "extractApolloCacheByKey",\n  args: [{ name: "key", type: ArgType.String }],\n  handler: (args) => {\n    const { key } = args ?? {};\n    if (key) {\n      const findValue = getNestedCacheValue(key);\n      if (findValue) {\n        Reactotron.display({\n          name: "Apollo Cache",\n          preview: `Cache Value for Key: ${key}`,\n          value: findValue,\n        });\n      } else {\n        Reactotron.display({\n          name: "Apollo Cache",\n          preview: `Value not available for key: ${key}`,\n        });\n      }\n    } else {\n      Reactotron.log("Could not extract cache value. No key provided.");\n    }\n  },\n});\n'})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://github.com/infinitered/ignite-cookbook/assets/374022/2262dfc4-ce4e-409c-9ab5-3bfb0e45d788",alt:"Cache By Key Custom Command"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://github.com/infinitered/ignite-cookbook/assets/374022/e2659614-2322-45ec-93cc-1a09123bff4c",alt:"Cache By Key Timeline Collapsed"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{src:"https://github.com/infinitered/ignite-cookbook/assets/374022/86966b34-ba10-46ce-931c-de5579b5f6c4",alt:"Cache By Key Timeline Expanded"})}),"\n",(0,o.jsxs)(n.p,{children:["Head back to your Reactotron UI and you'll see the Custom Command at the bottom (or top, depending on how you register in your config) available for use. You can now extract values from more complex key paths such as ",(0,o.jsx)(n.code,{children:'ROOT_QUERY.chapter({"id":1}).sections[2]'})," rather than having to traverse the entire object."]})]})}function d(e={}){const{wrapper:n}={...(0,a.M)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},2172:(e,n,t)=>{t.d(n,{I:()=>s,M:()=>l});var o=t(1504);const a={},i=o.createContext(a);function l(e){const n=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:l(e.components),o.createElement(i.Provider,{value:n},e.children)}}}]);